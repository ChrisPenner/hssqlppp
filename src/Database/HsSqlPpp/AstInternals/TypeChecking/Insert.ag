{-
================================================================================

= insert

check the insert data is the correct type. Doesn't cope with columns
with default values at the moment.

-}

SEM Statement
    | Insert
        loc.tpe = either Left (const $ Right $ Pseudo Void) @loc.columnTypes
        loc.statementType = Just (catMaybes $ getPlaceholderTypes @loc.insDataAddedInferredTypes
                                 ,@returning.listType)
        -- column types is the name,type list for the columns
        -- mentioned in the select expression being inserted
        loc.columnTypes : {Either [TypeError] [(String,Type)]}
        loc.columnTypes =
          do
          atts <- catCompositePublicAttrs @lhs.cat relationComposites @table
          expAtts <- lmt (getTypeAnnotation @insData.annotatedTree)
                     >>= unwrapSetOfComposite
          let eNames = map fst expAtts
          tAtts <- case @targetCols of
                        [] -> return atts
                        _ -> mapM (lkpA atts) @targetCols
          checkAssignmentsValid @lhs.cat (map snd expAtts) (map snd tAtts)
          return tAtts
          where
            lkpA :: [(String,Type)] -> String -> E (String,Type)
            lkpA m n = maybe (Left [UnrecognisedIdentifier n])
                             (\t -> Right (n,t))
                             $ lookup n m
        loc.insDataAddedInferredTypes =
            either (const @insData.annotatedTree) id $
            case @insData.annotatedTree of
              Values ann [exl] -> do
                  fargs <- map (Just . snd) <$> @loc.columnTypes
                  let newExl = map setInfType $ zip (fargs ++ repeat Nothing) exl
                  return $ Values ann [newExl]
              x -> return x
            where
              setInfType :: (Maybe Type,Expression) -> Expression
              setInfType (t,a) = updateAnnotation (\i -> i {infType = t}) a

        loc.backTree = Insert @ann @table @targetCols
                              @loc.insDataAddedInferredTypes
                              @returning.annotatedTree
        loc.catUpdates = []

-- inject the ids into the returning part

SEM Statement
    | Insert
        returning.lib =
            either (const @lhs.lib) id $ do
              atts <- catCompositeAttrs @lhs.cat relationComposites @table
              lbUpdate @lhs.cat (LBIds "insert target table" "" atts []) @lhs.lib

